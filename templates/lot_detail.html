{% extends "base.html" %}

{% block title %}{{ lot.lot_number }} - TenderFinder{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('catalog') }}" style="color: var(--primary-color); text-decoration: none;">
            ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥
        </a>
    </div>
    
    <!-- Lot Header -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <div class="lot-number" style="font-size: 1rem; margin-bottom: 0.5rem;">
                    {{ lot.lot_number }}
                </div>
                <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
                    {{ lot.simplified_name or lot.original_name }}
                </h1>
                {% if lot.customer %}
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        üè¢ –ó–∞–∫–∞–∑—á–∏–∫: {{ lot.customer }}
                    </p>
                {% endif %}
            </div>
            
            <div style="text-align: right;">
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    –¶–µ–Ω–∞ —Ç–µ–Ω–¥–µ—Ä–∞:
                </div>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-color);">
                    {{ "{:,.0f}".format(lot.tender_price) }} ‚Ç∏
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; padding: 1.5rem; background: var(--light-bg); border-radius: 0.5rem;">
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                </div>
                <div style="font-size: 1.5rem; font-weight: 700;">
                    {{ lot.quantity }} {{ lot.unit or '—à—Ç' }}
                </div>
            </div>
            
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                    –¢–æ–≤–∞—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-color);">
                    {{ total_products }}
                </div>
            </div>
            
            {% if lot.category %}
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                </div>
                <div style="font-size: 1.125rem; font-weight: 600;">
                    {{ lot.category }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Country Tabs -->
    <div class="country-tabs">
        {% if products_by_country['CN'] %}
        <button class="country-tab active" data-country="CN">
            üá®üá≥ –ö–∏—Ç–∞–π ({{ products_by_country['CN']|length }})
        </button>
        {% endif %}
        
        {% if products_by_country['RU'] %}
        <button class="country-tab {% if not products_by_country['CN'] %}active{% endif %}" data-country="RU">
            üá∑üá∫ –†–æ—Å—Å–∏—è ({{ products_by_country['RU']|length }})
        </button>
        {% endif %}
        
        {% if products_by_country['KZ'] %}
        <button class="country-tab {% if not products_by_country['CN'] and not products_by_country['RU'] %}active{% endif %}" data-country="KZ">
            üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω ({{ products_by_country['KZ']|length }})
        </button>
        {% endif %}
    </div>
    
    <!-- China Products -->
    {% if products_by_country['CN'] %}
    <div class="country-panel" data-country="CN">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">
            üá®üá≥ –¢–æ–≤–∞—Ä—ã –∏–∑ –ö–∏—Ç–∞—è
        </h2>
        
        {% for product in products_by_country['CN'] %}
        <div class="product-item">
            <div class="product-info">
                <div class="product-title">{{ product.product_title }}</div>
                <div class="product-marketplace">
                    {% if product.marketplace == 'aliexpress' %}
                        üõí AliExpress
                    {% elif product.marketplace == 'pinduoduo' %}
                        üõí Pinduoduo
                    {% elif product.marketplace == 'taobao' %}
                        üõí Taobao
                    {% elif product.marketplace == '1688' %}
                        üõí 1688.com
                    {% else %}
                        üõí {{ product.marketplace }}
                    {% endif %}
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç:</div>
                    <div class="product-price">{{ product.product_price }}</div>
                </div>
                
                {% set price_numeric = product.product_price|replace('¬•', '')|replace(',', '')|float %}
                {% set total_price = price_numeric * lot.quantity %}
                
                <div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">–û–±—â–∞—è —Å—É–º–º–∞:</div>
                    <div style="font-size: 1.125rem; font-weight: 700; color: var(--text-primary);">
                        ¬•{{ "{:,.2f}".format(total_price) }}
                    </div>
                </div>
                
                <a href="{{ product.product_url }}" target="_blank" class="btn btn-primary">
                    –û—Ç–∫—Ä—ã—Ç—å ‚Üí
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Russia Products -->
    {% if products_by_country['RU'] %}
    <div class="country-panel" data-country="RU" style="display: {% if products_by_country['CN'] %}none{% else %}block{% endif %};">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">
            üá∑üá∫ –¢–æ–≤–∞—Ä—ã –∏–∑ –†–æ—Å—Å–∏–∏
        </h2>
        
        {% for product in products_by_country['RU'] %}
        <div class="product-item">
            <div class="product-info">
                <div class="product-title">{{ product.product_title }}</div>
                <div class="product-marketplace">üõí {{ product.marketplace }}</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç:</div>
                    <div class="product-price">{{ product.product_price }}</div>
                </div>
                
                <a href="{{ product.product_url }}" target="_blank" class="btn btn-primary">
                    –û—Ç–∫—Ä—ã—Ç—å ‚Üí
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Kazakhstan Products -->
    {% if products_by_country['KZ'] %}
    <div class="country-panel" data-country="KZ" style="display: {% if products_by_country['CN'] or products_by_country['RU'] %}none{% else %}block{% endif %};">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">
            üá∞üáø –¢–æ–≤–∞—Ä—ã –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
        </h2>
        
        {% for product in products_by_country['KZ'] %}
        <div class="product-item">
            <div class="product-info">
                <div class="product-title">{{ product.product_title }}</div>
                <div class="product-marketplace">üõí {{ product.marketplace }}</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç:</div>
                    <div class="product-price">{{ product.product_price }}</div>
                </div>
                
                <a href="{{ product.product_url }}" target="_blank" class="btn btn-primary">
                    –û—Ç–∫—Ä—ã—Ç—å ‚Üí
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if total_products == 0 %}
    <div class="card text-center" style="padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üì¶</div>
        <h3 style="margin-bottom: 1rem;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p style="color: var(--text-secondary);">
            –î–ª—è —ç—Ç–æ–≥–æ –ª–æ—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        </p>
    </div>
    {% endif %}
    
    <!-- Profit Calculator -->
    {% if products_by_country['CN'] %}
    <div class="card" style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--primary-color);">
            üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
        </h3>
        
        {% set min_price = products_by_country['CN'][0].product_price|replace('¬•', '')|replace(',', '')|float %}
        {% for product in products_by_country['CN'] %}
            {% set price = product.product_price|replace('¬•', '')|replace(',', '')|float %}
            {% if price < min_price %}
                {% set min_price = price %}
            {% endif %}
        {% endfor %}
        
        {% set total_cost = min_price * lot.quantity %}
        {% set margin = lot.tender_price - total_cost %}
        {% set margin_percent = (margin / lot.tender_price * 100) %}
        
        <div class="grid grid-3">
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤
                </div>
                <div style="font-size: 1.5rem; font-weight: 700;">
                    ¬•{{ "{:,.2f}".format(total_cost) }}
                </div>
            </div>
            
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    –¶–µ–Ω–∞ —Ç–µ–Ω–¥–µ—Ä–∞
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">
                    {{ "{:,.0f}".format(lot.tender_price) }} ‚Ç∏
                </div>
            </div>
            
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: {% if margin > 0 %}var(--secondary-color){% else %}var(--danger-color){% endif %};">
                    {{ "{:,.0f}".format(margin) }} ‚Ç∏ ({{ "{:.1f}".format(margin_percent) }}%)
                </div>
            </div>
        </div>
        
        {% if margin > 0 %}
        <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border-left: 4px solid var(--secondary-color);">
            <p style="font-weight: 600; color: var(--secondary-color);">
                ‚úÖ –≠—Ç–æ—Ç —Ç–µ–Ω–¥–µ—Ä –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–∏–±—ã–ª—å–Ω—ã–π!
            </p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ –∏–∑ –ö–∏—Ç–∞—è –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –æ–∫–æ–ª–æ {{ "{:,.0f}".format(margin) }} ‚Ç∏
            </p>
        </div>
        {% else %}
        <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
            <p style="font-weight: 600; color: var(--danger-color);">
                ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫
            </p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                –°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ü–µ–Ω—É —Ç–µ–Ω–¥–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—á–µ—Ç—ã –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
            </p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Country tabs functionality is in main.js
</script>
{% endblock %}
